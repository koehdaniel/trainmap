<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8"/>
    <title>TrainMap - Track your Journeys</title>
    <!-- Leaflet CSS -->
    <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
            integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
            crossorigin=""
    />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .form label {
            display: block;
            margin-bottom: 10px;
        }

        .form select {
            width: 220px;
            padding: 5px;
        }
    </style>
    <style>
        .vs__selected{
            max-width: 134px;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }
    </style>
</head>
<body style="display:inline-block">
<div id="app" style="display:inline-block">
    <journey-editor></journey-editor>
    <map-form></map-form>
</div>

<!-- Vue via CDN (Vue 2) -->
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<!-- Leaflet JS -->
<script
        src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
        integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
        crossorigin=""
></script>

<!-- Include Vue Select CSS -->
<link rel="stylesheet" href="https://unpkg.com/vue-select@latest/dist/vue-select.css">
<!-- Include Vue Select JS -->
<script src="https://unpkg.com/vue-select@latest"></script>


<script>
    Vue.component('v-select', VueSelect.VueSelect);
    Vue.component('station-selector', {
        props: [ 'station', 'debug' ],
        template: `
          <label style="display: inline-block; width: 200px;" :class="debug">
            <slot></slot>
            <span v-if="!$slots">:</span>
            <v-select
                v-model="entry"
                :options="entries"
                label="name"
                :filterable="true"
                @search="onSearchInput"
                @input="onItemSelected"
                placeholder="Type to search"
            ></v-select>
          </label>

        `,
        data() {
            return {
                entry: '',
                entries: []
            }
        },
        methods: {
            onSearchInput(searchTerm) {
                // console.log(searchTerm);
                if (searchTerm.length >= 1) {
                    this.loadStations(searchTerm)
                }
            },
            onItemSelected(event) {
                this.$emit("station-selected", {
                    entry: this.entry
                })
            },
            loadStations(input) {
                fetch("https://trainmap.flubb.de/location.php?name=" + input)
                    .then(response => response.json())
                    .then(locations => {
                        locations.forEach(l => {
                            if (!this.entries.find(s => s.id === l.id)) {
                                this.entries.push(l);
                            }
                        })
                    })
                    .catch(error => {
                        console.error('Error loading stations:', error);
                    });
            }
        },
        mounted() {
            console.log("station-selector mounted with props:", this.station)
            this.entry = this.station; //TODO watch if prop changes later on!!!
            console.log("station-selector-debug:", this.debug)
        },
        watch: {
            station: function(newVal, oldVal) {
                console.log("prop station changed:", this.debug, newVal, oldVal)
                this.entry = newVal;
            }
        }
    })
    Vue.component('journey-editor', {
        template: `
          <div id="journey-editor">
            <journey-section @journey-section-added="addJourneySection"
                             @journey-section-removed="removeJourneySection"
                             v-for="(journey, index) in journeys"
                             :key="journey.travelSection.from.id + '-' + journey.travelSection.to.id"
                             :header="index === 0"
                             :journey="journey" :debug="index"></journey-section>
            <journey-section @journey-section-added="addJourneySection"
                             @journey-section-removed="removeJourneySection"
                             :header="journeys.length === 0"
                             last_line="true" debug="bottom"></journey-section>
          </div>
        `,
        data() {
            return {
                journeys: []
            }
        },
        methods: {
            addJourneySection(journeySection) {
                this.journeys.push(journeySection);
                console.log(this.journeys);
                this.$root.$emit("journeys-updated", this.journeys);
            },
            removeJourneySection(journeySection) {
                console.log("removeJourneySection", journeySection)
                this.journeys = this.journeys.filter(journey => {
                    console.log("find-journey", journey)
                    return journey.travelSection.from.id != journeySection.travelSection.from.id && journey.travelSection.to.id != journeySection.travelSection.to.id;
                });
                this.$root.$emit("journey-section-removed", {
                    travelSection: journeySection.travelSection
                })
            }
        }
    })
    Vue.component('journey-section', {
        props: [ 'header', 'journey', 'last_line', 'debug' ],
        template: `
          <div id="journey-plan"
               style="background-color:#fff; padding: 10px; margin-left: 50px; width: 405px; z-index:5;">
            <div class="journey-form">
              <station-selector @station-selected="setFrom" :station="this.from" :debug="this.debug + 'li'"><span v-if="header !== false">Departure</span></station-selector>
              <station-selector @station-selected="setTo" :station="this.to" :debug="this.debug + 're'"><span v-if="header !== false">Arrival</span></station-selector>
            </div>
          </div>`,
        data() {
            return {
                from: null,
                to: null
            };
        },
        methods: {
            setFrom(msg) {
                if(this.from != null){
                    this.removeRoute();
                }
                this.from = msg.entry;
                this.addRoute();
            },
            setTo(msg) {
                if(this.to != null){
                    this.removeRoute();
                }
                this.to = msg.entry;
                this.addRoute();
            },
            addRoute() {
                if(this.from != null && this.to != null) {
                    this.$emit('journey-section-added', {
                        travelSection: {
                            from: {...this.from},
                            to: {...this.to},
                            id: this.from.id + "-" + this.to.id,
                            debug: 'Line200'
                        }
                    });

                    if(this.last_line === "true") {
                        this.$nextTick(() => {
                            this.reset();
                        })
                    }
                    console.log("added-route", "header:", this.header, "journey:", this.journey, "last_line:", this.last_line)
                }
            },
            removeRoute(){
                this.$emit('journey-section-removed', {
                    travelSection: {
                        from: {...this.from},
                        to: {...this.to},
                        id: this.from.id + "-" + this.to.id,
                        debug: 'Line215'
                    }
                })
            },
            reset(){
                console.log("reset", this.debug, "header:", this.header, "journey:", this.journey, "last_line:", this.last_line)
                // this.to = { id: -1, name: "", longitude: -1, latitude: -1};
                // this.from = { id: -1, name: "", longitude: -1, latitude: -1};

                this.to = null;
                this.from = null;
            }
        },
        mounted() {
            console.log("journey-section mounted with props", this.journey)
            if(this.journey){
                this.from = this.journey.travelSection.from;
                this.to = this.journey.travelSection.to;
            }
            console.log("journey-section-debug:", this.debug)
        }
    })
    Vue.component("map-form", {
        template: `
          <div id="map" ref="map"
               style="height: 100vh; width: 100vw; top:0; position: absolute; left:0; z-index: -1;"></div>
        `,
        data() {
            return {
                map: null,
                lines: new Map()
            };
        },
        methods: {
            visualizeRoute(from, to) {
                if (!from || !to) {
                    alert("Please select both stations");
                    return;
                }
                // Build URL using selected station ids (startBahnhof and zielBahnhof)
                const url = `https://trainmap.flubb.de/route.php?from_lon=${from.longitude}&from_lat=${from.latitude}&to_lon=${to.longitude}&to_lat=${to.latitude}&order=lat,lon`;
                fetch(url)
                    .then(response => response.json())
                    .then(coords => {
                        // Convert coordinates from [lon, lat] to [lat, lon]
                        // const coords = data.map(pair => [pair[1], pair[0]]);
                        // Create a polyline for the route (blue color)
                        let routePolyline = L.polyline(coords, {color: "blue"}).addTo(this.map);
                        this.map.fitBounds(routePolyline.getBounds());
                        console.log("add-line", from.id + "-" + to.id, routePolyline)
                        this.lines.set(from.id + "-" + to.id, routePolyline);
                    })
                    .catch(error => console.error("API error:", error));
            },
            initMap() {
                // Initialize the map (centered roughly on France)
                this.map = L.map(this.$refs.map).setView([50.825952, 9.03693], 6);
                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    attribution: "&copy; OpenStreetMap contributors"
                }).addTo(this.map);
            }
        },
        mounted() {
            this.initMap();
            this.$root.$on('journey-section-added', (payload) => {
                console.log("journey-section-added", payload);
                this.visualizeRoute(payload.travelSection.from, payload.travelSection.to);
            })

            this.$root.$on('journey-section-removed', (payload) => {
                console.log("journey-section-removed", payload);
                // this.visualizeRoute(payload.travelSection.from, payload.travelSection.to);
                let line = this.lines.get(payload.travelSection.id);
                console.log("line", line);
                line.remove();
                this.lines.delete(payload.travelSection.id)
                console.log("lines", this.lines)
            })

            this.$root.$on('journeys-updated', (journeys) => {
                console.log("journeys-updated", journeys);
                let mappy = this.map;
                // this.map.eachLayer(function (layer) {
                //     console.log(layer);
                //     mappy.removeLayer(layer);
                // })

                let removedJourneys = [];
                //remove lines if journey doesnt exist anymore
                this.lines.forEach((line, id) => {
                    if(!journeys.find(journey => {
                        return journey.travelSection.id === id;
                    })){
                        console.log("No Journey for line with id:", id, journeys)
                        removedJourneys.push(id);
                        console.log("remove-line", line);
                        line.remove();
                    }
                })
                removedJourneys.forEach(id => this.lines.delete(id));
                //visualize journey, if line not yet created
                journeys.forEach(journey => {
                    if(this.lines.get(journey.travelSection.from.id + "-" + journey.travelSection.to.id) === undefined) {
                        this.visualizeRoute(journey.travelSection.from, journey.travelSection.to);
                    }
                })

            })
        }
    });

    new Vue({
        el: "#app"
    });
</script>
</body>
</html>
